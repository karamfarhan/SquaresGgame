{% extends 'base.html' %}

{% block content %}
{{name|json_script:"name" }}
{{ game_id|json_script:"game_id" }}
{{color|json_script:"color"}}


<div class="information text-center d-flex flex-column"></div>


<div id="timer"></div>

<div class="board-border"></div>

<div class="wait" id="wait"></div>


<div id="dialog-container" class="dialog-container ">
  <div class="dialog-header">Results...</div>
  <div id="dialog-body" class="dialog-body">
  </div>
  <div class="dialog-footer">
    <button class="exit"> <a href="{% url 'game:home' %}">Exit</a> </button>
    <button class="refresh">
      Play again
  </div>
</div>

<script>
  function checkEvt(){
      var evTypep=window.performance.getEntriesByType("navigation")[0].type;
        if (evTypep=='reload'){
          window.location.replace(`http://${window.location.host}`);
        }

  }
  checkEvt();

  var name = JSON.parse(document.getElementById("name").textContent);
  var gameId = JSON.parse(document.getElementById("game_id").textContent);
  var color = JSON.parse(document.getElementById("color").textContent);
  var container = document.querySelector(".board-border");
  var playerInform = document.querySelector(".information")
  var timer = document.getElementById("timer");



  const ws = new WebSocket(`ws://${window.location.host}/ws/game/${gameId}/${name}/`);
  while (container.firstChild) container.removeChild(container.firstChild);


  function displayPlayers(players) {
    playerInform.innerHTML = ''
    let ul = document.createElement("ul")

    for (const key in players) {
      let li = document.createElement("li"),
        spanName = document.createElement('span'),
        spanColor = document.createElement('span')
        spanSquares = document.createElement('span')

      li.classList.add("menu-btn")
      li.classList.add("mt-2")
      spanName.className = players[key].name;
      spanColor.className = players[key].color;
      // spanSquares.setAttribute("id",`S-${players[key].color}`)
      spanColor.setAttribute("id", players[key].color)

      spanName.textContent = players[key].name;
      // spanSquares.innerHTML = players[key].occupied
      spanName.style.color = "white"
      spanSquares.style.color = "white"
      spanSquares.classList.add("squares-occupied")
      spanColor.classList.add("player-circle-color")
      spanColor.style.backgroundColor = players[key].color
      spanSquares.setAttribute("id", spanColor.style.backgroundColor)
      li.appendChild(spanName)
      li.appendChild(spanColor)
      li.appendChild(spanSquares)
      ul.appendChild(li)
    }
    playerInform.appendChild(ul)
  }


  //pop up
  let reloadBtn = document.querySelector(".refresh");
  let exitBtn = document.querySelector(".exit");
  exitBtn.addEventListener("click", () => {
    window.href
  });

  reloadBtn.addEventListener('click', () => {
    const PayLoad = {
      method: "restart_game",
      data: {
        game_id: gameId,
        name: name,
        color: color,

      }
    }
    var alert = document.querySelector(".dialog-container")
    ws.send(JSON.stringify(PayLoad))
    container.classList.remove("done");
    alert.classList.remove("active");
    container.innerHTML = ''
    playerInform.innerHTML = ''

  })

  function getvals() {
    return fetch(`http://localhost:8000/result/?game_id=${gameId}`)
      .then((response) => {})
      .then((responseData) => {})
      .catch(error => console.warn(error));
  }

  function countResluts() {
    const allSquares = document.querySelectorAll(".cell");

    let LastResult = {}

    // console.log(square)
    for ( square of allSquares){
      console.log(square)
      let sqcolor = square.style.backgroundColor
      if (sqcolor != ""){
        LastResult[String(sqcolor)] = (LastResult[String(sqcolor)] + 1) || 1;
      }
    }
    return LastResult
}
  function printResult(data){
    for ( colordata of Object.keys(data)){
      // console.log(document.getElementById(color))
      document.getElementById(colordata).innerHTML = data[colordata]
    }
  }

  function countdown() {
    var seconds = 10;
    function tick() {
      // var counter = document.getElementById("counter");
      seconds--;
      timer.innerHTML = "0:" + (seconds < 10 ? "0" : "") + String(seconds);
      if (seconds > 0) {
        setTimeout(tick, 1000);
      } else {

        container.classList.add("done");
        getvals();
        document.querySelector(".dialog-container").classList.add("active");
        let data = countResluts()
        printResult(data)
        document.getElementById("timer").innerHTML = "";
      }
    }
    tick();
  }



  function clickHandle(p) {
    if (p.innerHTML == "") {
      return 0
    } else {
      return parseInt(p.innerHTML)
    }
  }

  function update_square(squareData) {
    let squareId = squareData.squareId;
    let squareObject = document.getElementById(squareId);
    let squareP = document.getElementById(squareId).getElementsByTagName("p")[0]
    // let occupier = document.getElementById(`S-${squareData.color}`)
    // let occupied = document.getElementById(`S-${squareData.lastColor}`)

    squareObject.style.backgroundColor = squareData.color;
    squareP.innerHTML = squareData.clicked


    // occupier.innerHTML = parseInt(occupier.innerHTML) + 1
    // occupied.innerHTML = parseInt(occupied.innerHTML) - 1



  }


  function makesqu(squares) {
    container.innerHTML = ''
    //squares send messages
    for (let i = 1; i < Object.keys(squares).length + 1; i++) {



      let div = document.createElement("div");
      let p = document.createElement("p")
      let click_number = squares[i]["clicked"]
      div.appendChild(p)
      div.className = "cell";
      div.id = (i);
      // div.setAttribute("name", squares[i]["color"])
      if (click_number != 0) {
        p.innerHTML = click_number
      }
      // p.innerHTML = click_number

      div.tag = i;
      div.style.backgroundColor = squares[i]["color"];
      div.addEventListener("click", (e) => {
        const user_color_rgb = document.getElementById(color).style.backgroundColor


        if (div.style.backgroundColor !== user_color_rgb) {

          div.style.backgroundColor = color;
          let prev_click = clickHandle(p)
          p.innerHTML = prev_click + 1

          const PayLoad = {
            method: "update_ball",
            data: {
              squareId: div.tag,
              color: color,
              clicked: prev_click + 1,
              // lastColor: div.style.backgroundColor,
            }
          }
          ws.send(JSON.stringify(PayLoad))
        }

      });

      container.appendChild(div);
    }

  }

  // ws recieve message from django
  ws.onmessage = (message) => {
    const data = JSON.parse(message.data);
    if (data.method === "update_square") {
      console.log(data.data)
      update_square(data.data)

    }
    if (data.method === "send_game") {
      squares = data.data.squares
      players = data.data.players
      displayPlayers(players)
      if (data.data.is_started === true) {
        document.getElementById("wait").innerHTML = ''
        makesqu(squares)

      }
    }
    if (data.method === "start_timer"){
      countdown();
      console.log(data.data)
    }
    if (data.method === "update_players") {
      let WaitMesage = document.createElement("h2")
      let WaitDiv = document.getElementById("wait")
      WaitDiv.innerHTML = ''
      players = data.data.players
      displayPlayers(players)
      if (data.data.waiting === true && name in players) {
        WaitDiv.innerHTML = ''
        WaitMesage.innerHTML = `
        <p>Wait the players to join, share the game code with them</p>
        <span style="color: green;">${gameId}</span>`
        WaitDiv.appendChild(WaitMesage)
      }
    }
    if (data.method === "send_results") {
      nat = ``
      for (result in data.data){
        nat += `<span style="color: ${data.data[result].color};">${data.data[result].name}</span> --> ${data.data[result].squares} <hr>`
      }
      document.getElementById("dialog-body").innerHTML = nat
      playerInform.innerHTML = ''
      container.classList.add("done");
      document.querySelector(".dialog-container").classList.add("active");
    }
  };

</script>
{% endblock content %}
